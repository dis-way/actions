name: Terraform Apply
description: Apply a previously generated terraform plan
inputs:
  working_directory:
    description: The directory where the Terraform project is located.
    default: ./infrastructure
    required: true

  arm_client_id:
    required: true
    description: Federated Azure Client ID.
  arm_subscription_id:
    required: true
    description: Azure Subscription ID
  arm_tenant_id:
    description: Azure Tenant ID
    default: cd0026d8-283b-4a55-9bfa-d0ef4a8ba21c

  tf_backend_subscription_id:
    default: a6e9ee7d-2b65-41e1-adfb-0c8c23515cf9
    description: Azure Subscription ID for the storage account that persists the terraform state
  tf_backend_resource_group_name:
    description: Azure resource group for the storage account that persists the terraform state
    default: github-dis-way
  tf_backend_storage_account_name:
    description: Name of the azure storage account that persists the terraform state
    default: diswaytfstatestorage
  tf_backend_container_name:
    description: Name of the azure storage container that persists the terraform state
    default: ${{ github.event.repository.name }}
  tf_backend_state_name:
    description: Name of Terraform state file
    required: true
  tf_version:
    description: Terraform Version
  tf_log_level:
    description: Terraform Log level
    default: INFO
  tf_args:
    description: Terraform arguments
    required: false
  tf_output_file:
    description: JSON file for dumping tf state output
    default: tf_output.json

runs:
  using: composite
  steps:
    - name: Terraform Init
      uses: dis-way/actions/terraform/init@df88a66211a70db08cd9e0484d33a5ce27e1258e
      with:
        working_directory: ${{ inputs.working_directory }}

        arm_client_id: ${{ inputs.arm_client_id }}
        arm_subscription_id: ${{ inputs.arm_subscription_id }}
        arm_tenant_id: ${{ inputs.arm_tenant_id }}

        tf_backend_subscription_id: ${{ inputs.tf_backend_subscription_id }}
        tf_backend_resource_group_name: ${{ inputs.tf_backend_resource_group_name }}
        tf_backend_storage_account_name: ${{ inputs.tf_backend_storage_account_name }}
        tf_backend_container_name: ${{ inputs.tf_backend_container_name }}
        tf_backend_state_name: ${{ inputs.tf_backend_state_name }}

        tf_version: ${{ inputs.tf_version }}
        tf_log_level: ${{ inputs.tf_log_level }}

    - name: Artifact Key
      id: artifact_key
      shell: bash
      run: |
        set -euo pipefail
        ARTIFACT_KEY="${{ inputs.tf_backend_state_name }}.tfplan"
        echo "ARTIFACT_KEY=$ARTIFACT_KEY" >> $GITHUB_ENV

    - name: Download Plan
      id: artifact
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: ${{ env.ARTIFACT_KEY }}
        path: ${{ inputs.working_directory }}

    - name: Validate Plan File
      shell: bash
      run: |
        set -euo pipefail
        if [ ! -f "${{ inputs.working_directory }}/tfplan.out" ]; then
          echo "Error: Plan file tfplan.out not found in ${{ inputs.working_directory }}"
          exit 1
        fi

    - name: Terraform Apply
      id: apply
      working-directory: ${{ inputs.working_directory }}
      shell: bash
      run: |
        set -euo pipefail
        echo "Applying Terraform plan..."
        terraform apply -input=false -auto-approve $TERRAFORM_ARGS tfplan.out
        echo "Capturing Terraform outputs..."
        terraform output -json > $TERRAFORM_OUTPUT_FILE
        echo "Terraform apply completed successfully"
      env:
        ARM_CLIENT_ID: ${{ inputs.arm_client_id }}
        ARM_SUBSCRIPTION_ID: ${{ inputs.arm_subscription_id }}
        ARM_TENANT_ID: ${{ inputs.arm_tenant_id }}
        ARM_USE_OIDC: "true"
        ARM_USE_AZUREAD_AUTH: "true"
        TERRAFORM_ARGS: ${{ inputs.tf_args }}
        TERRAFORM_OUTPUT_FILE: ${{ inputs.tf_output_file }}
